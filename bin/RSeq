#!/bin/bash

# From https://stackoverflow.com/questions/59895/how-can-i-get-the-source-directory-of-a-bash-script-from-within-the-script-itsel
# This solution works for direct paths and symlinks alike
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
BINDIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Print a file from the source directory
SRCDIR="$BINDIR"/../src

# Usage info
usage() {
  echo
  echo "#############################################################################################"
  echo "                   ____  _____                        ________    ____             "
  echo "                  / __ \/ ___/___  ______            / ____/ /   /  _/             "
  echo "                 / /_/ /\__ \/ _ \/ __  /  ______   / /   / /    / /               "
  echo "                / _, _/___/ /  __/ /_/ /  /_____/  / /___/ /____/ /                "
  echo "               /_/ |_|/____/\___/\__  /            \____/_____/___/                "
  echo "                                   /_/                                             "
  echo "#############################################################################################"
  echo
  echo "RSeq [-e experiment] [-c control] [-m mode] [-g genome] [-n name]"
  echo
  echo "  -e|--experiment        fq/bam/SRA    Experiment(s). Use -e1, -e2 for paired-end fq files."
  echo "  -c|--control           fq/bam/SRA    Control(s). Use -c1, -c2 for paired-end fq files."
  echo "  -m|--mode              str           Analysis mode ('DRIP', 'RChIP', etc.)"
  echo "  -g|--genome            str           UCSC genome for samples (e.g., 'hg38')"
  echo "  -n|--name              str           Sample names(s) for use in output files."
  echo "  -s|--sampleSheet       csv           CSV file describing samples (overrides -e/-c/-m/-g/-n)."
  echo "  -o|--outputDir         dir           Output directory. [default = 'RSeq_out/']"
  echo "  -G|--genomeDir         dir           Genome directory. [default = '~/.RSeq_genomes']"
  echo "  -t|--threads           int           Specify number of threads. [default = 1]"
  echo "  -r|--rseqVars          json          rseqVars.json file (above options are ignored)."
  echo "  -S|--snakeArgs         str           Keyword arguments to snakemake.api. [default: use_conda=True]"
  echo "  -b|--bwa_mem2                        Align with BWA-MEM2 instead of BWA. (Needs > 70GB RAM)"
  echo "  -v|--version                         Display version info"
  echo "  -h|--help                            Display detailed usage"
  echo
  echo "Examples (see detailed usage for more):"
  echo
  echo "RSeq -e treated.fastq -c untreated.fastq -m DRIP -g mm10 -n my_experiment -o RSeq_out/ -t 20"
  echo
  echo "RSeq -e1 treated_A.R1.fastq treated_B.R1.fastq -e2 treated_A.R2.fastq treated_B.R2.fastq -m R-ChIP -g dm6"
  echo
  echo "RSeq -e SRX1025890 -m DRIP"
  echo
  echo "Thank you for using RSeq. Please cite Bishop-Laboratory/RSeq"
  echo

}

usageDetail() {
  # From: https://stackoverflow.com/questions/7314044/use-bash-to-read-line-by-line-and-keep-space
  IFS=''
  while read -r lines; do
    echo "$lines"
  done < "$SRCDIR"/usage_details.txt

}

version() {
  echo
  echo "RSeq v0.0.1"
  echo
}

# Check for usage
if [[ "$#" -eq 0 ]] ; then
    usage
    exit 0
fi

# Argparse & pre-process
echo
echo "Parsing input..."
echo
inputJSON=$(Rscript "$SRCDIR"/scripts/process_input.R "$@" "$SRCDIR")

# Check if version or usage
if [ "$inputJSON" == "usage" ]; then
  usageDetail
  exit 0
elif [ "$inputJSON" == "version" ]; then
  version
  exit 0
elif [ ! -f "$inputJSON" ]; then
  echo "$inputJSON"
  echo "Not a file!"
  echo
  exit 1
fi

# Run the pipeline!
python "$SRCDIR"/scripts/run_workflow.py "$inputJSON"

echo
exit 0
