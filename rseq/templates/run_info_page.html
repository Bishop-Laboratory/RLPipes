<!--Most of this is ripped straight from the snakemake gui html -->
<!--https://github.com/snakemake/snakemake/blob/master/snakemake/gui.html-->
{% extends 'base.html' %}

{% block content %}
<style>
</style>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="//d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3-graphviz/3.1.0/d3-graphviz.min.js"></script>
<script>
  var status = {{status|tojson|safe}};
  console.log(status);

  var configs = {{sample_dict|tojson|safe}}
  console.log(configs)

  jQuery(document).ready(function($){
    $.ajax({
          type: "get",
          url: "/runs/{{run_id}}/track_flight",
          data: {
            samples: Object.keys(configs)
          },
          success:function(response) {
            var json = JSON.parse(response);
            console.log(json);
            console.log(json['SRX2481503_S96_DRIP_Seq_1']['DAG'])
            var diagraph = json['SRX2481503_S96_DRIP_Seq_1']['DAG']
            d3.select("#dag_canvas").graphviz().renderDot(diagraph);
          }
        });
  });


  var include_arr = ["\u003cstrong class=\"text-info\"\u003eIn flight \u2708\ufe0f\u003c/strong\u003e",
                     "\u003cstrong class=\"text-info\"\u003eSafely aborting\u003c/strong\u003e"]

  if (include_arr.includes(status)) {
    setInterval(function() {
      $.ajax({
        type: "get",
        url: "/runs/{{run_id}}/track_flight",
        success:function(response) {
          var json = JSON.parse(response);
          console.log(json);
          console.log(json['msg']);
          if (['aborted', 'failed'].includes(json['msg'])) {
            window.location.href = "/runs/{{run_id}}/monitor";
           };
        }
      });
    }, 5000);
  } else {
    console.log("Not running yet.");
  }

</script>


<div class="row">
  <div class="col">
    <div class="d-flex align-items-center">
      <h1 style="display: inline;">Control panel for '{{run_name}}'&nbsp;</h1>
      {% if status == '<strong class="text-info">Ready for takeoff üõ´</strong>' %}
        <a role="button" href="/runs/{{run_id}}/takeoff" id="run-btn" class="btn btn-success">Takeoff</a>
      {% elif status == '<strong class="text-info">In flight ‚úàÔ∏è</strong>' %}
        <a role="button" href="/runs/{{run_id}}/abort" id="terminate-btn" class="btn btn-danger">Abort</a>
      {% elif status == '<strong class="text-info">Safely aborting</strong>' %}
        <a role="button" href="/runs/{{run_id}}/abort" aria-disabled="true" id="abort-btn" class="btn btn-danger disabled">Abort</a>
      {% elif status == '<strong class="text-danger">Failed! ‚ùå</strong>' %}
      <a role="button" href="/runs/{{run_id}}/takeoff?" id="retryun-btn" class="btn btn-info">Retry unfinished</a>
      <a role="button" href="/runs/{{run_id}}/takeoff?rerun=true" id="retryall-btn" class="btn btn-warning">Retry all</a>
      {% elif status == '<strong class="text-info">Complete! ‚úîÔ∏è</strong>' %}
        <a role="button" href="/runs/{{run_id}}/report" id="report-btn" class="btn btn-info">View report</a>
        <a role="button" href="/runs/{{run_id}}/takeoff?rerun=true" id="rerun-btn" class="btn btn-warning">Re-run</a>
      {% endif %}
    </div>
  </div>
</div>

<hr>
<div class="row">
  <div class="col-4">
    <div class="list-group">
      {% for sample_name, sample_data in sample_dict.items() %}
      <div class="list-group-item flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{sample_name}}</h5>
          <small>last updated</small>
        </div>
        <div class="d-flex w-100 justify-content-between">
          <p class="mb-1">Status: {{ sample_data['status'] }}.</p>
          <div class="nav btn-group">
              <a href="#details" data-toggle="tab" class="btn btn-secondary">Details</a>
              <a href="#logs" data-toggle="tab" class="btn btn-secondary">Logs</a>
              <a href="#dag" data-toggle="tab" class="btn btn-secondary">DAG</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="col-8">
    <div class="tab-content" id="tabs">
      {% for sample_name, sample_data in sample_dict.items() %}
      <div class="tab-pane" id="details">
        <div class="card card-body">
          <h5 class="card-title">Details</h5>
          <p class="card-text">Experiment: {{ sample_data['experiments']}}</p>
          <p class="card-text">Control: {{ sample_data['controls']}}</p>
          <p class="card-text">Moeity: {{ sample_data['moeity']}}</p>
          <p class="card-text">IP type: {{ sample_data['ip_type']}}</p>
          <p class="card-text">Paired end: {{ sample_data['paired_end']}}</p>
          <p class="card-text">Output: {{ sample_data['out_dir']}}</p>
          <p class="card-text">Genome: {{ sample_data['genome']}}</p>
          <p class="card-text">Pipeline: {{ sample_data['mode']}}</p>
        </div>
      </div>
      <div class="tab-pane" id="logs">
        <div class="card card-body">
          <h5 class="card-title">Logs</h5>
        </div>
      </div>
      <div class="tab-pane" id="dag">
        <div class="card card-body">
          <h5 class="card-title">DAG</h5>
          <div id="dag_canvas"></div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>


<hr>
<div id="row">
  <div id="col">
    <a role="button" href="{{ url_for('dashboard.dashboard') }}" class="btn btn-default btn-lg">
      <span class="fa fa-chevron-left"></span> Dashboard
    </a>
  </div>
</div>

{% endblock %}
